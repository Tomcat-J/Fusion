from yacs.config import CfgNode as CN
from .utils import log_msg


def show_cfg(cfg):
    dump_cfg = CN()
    dump_cfg.EXPERIMENT = cfg.EXPERIMENT
    dump_cfg.DATASET = cfg.DATASET
    dump_cfg.DISTILLER = cfg.DISTILLER
    dump_cfg.SOLVER = cfg.SOLVER
    dump_cfg.LOG = cfg.LOG
    if cfg.DISTILLER.TYPE in cfg:
        dump_cfg.update({cfg.DISTILLER.TYPE: cfg.get(cfg.DISTILLER.TYPE)})
    print(log_msg("CONFIG:\n{}".format(dump_cfg.dump()), "INFO"))


CFG = CN()

# Experiment
CFG.EXPERIMENT = CN()
CFG.EXPERIMENT.PROJECT = "cifar100_baselines_resnet8x4"
CFG.EXPERIMENT.NAME = "resnet8x4"
CFG.EXPERIMENT.TAG = "/home/data/pyl/test_result"

# Dataset
CFG.DATASET = CN()
CFG.DATASET.TYPE = "lung"
CFG.DATASET.NUM_WORKERS = 2
CFG.DATASET.TEST = CN()
CFG.DATASET.TEST.BATCH_SIZE = 64

# Distiller

CFG.DISTILLER = CN()
CFG.DISTILLER.TYPE = "NONE"  # Vanilla as default
CFG.DISTILLER.TEACHER = "ResNet50"
CFG.DISTILLER.STUDENT = "resnet8x4"


# CFG.DISTILLER = CN()
# CFG.DISTILLER.TYPE = "NONE"  # Vanilla as default
# CFG.DISTILLER.TEACHER1 = "ResNet50"
# CFG.DISTILLER.TEACHER2 = "ResNet50"
# CFG.DISTILLER.STUDENT = "resnet8x4"


# Solver
CFG.SOLVER = CN()
CFG.SOLVER.TRAINER = "base"
CFG.SOLVER.BATCH_SIZE = 64
CFG.SOLVER.EPOCHS = 240
CFG.SOLVER.LR = 0.05
CFG.SOLVER.LR_DECAY_STAGES = [150, 180, 210]
CFG.SOLVER.LR_DECAY_RATE = 0.1
CFG.SOLVER.WEIGHT_DECAY = 0.0001
CFG.SOLVER.MOMENTUM = 0.9
CFG.SOLVER.TYPE = "SGD"

# Log
CFG.LOG = CN()
CFG.LOG.TENSORBOARD_FREQ = 500
CFG.LOG.SAVE_CHECKPOINT_FREQ = 40
CFG.LOG.PREFIX = "./output"
CFG.LOG.WANDB = False

# Distillation Methods

# KD CFG
CFG.KD = CN()
CFG.KD.TEMPERATURE = 4
CFG.KD.LOSS = CN()
CFG.KD.LOSS.CE_WEIGHT = 0.8
CFG.KD.LOSS.KD_WEIGHT = 0.2

# AT CFG
CFG.AT = CN()
CFG.AT.P = 2
CFG.AT.LOSS = CN()
CFG.AT.LOSS.CE_WEIGHT = 0.8
CFG.AT.LOSS.FEAT_WEIGHT = 0.2

# RKD CFG
CFG.RKD = CN()
CFG.RKD.DISTANCE_WEIGHT = 25
CFG.RKD.ANGLE_WEIGHT = 50
CFG.RKD.LOSS = CN()
CFG.RKD.LOSS.CE_WEIGHT = 1.0
CFG.RKD.LOSS.FEAT_WEIGHT = 1.0
CFG.RKD.PDIST = CN()
CFG.RKD.PDIST.EPSILON = 1e-12
CFG.RKD.PDIST.SQUARED = False

# FITNET CFG
CFG.FITNET = CN()
CFG.FITNET.HINT_LAYER = 2  # (0, 1, 2, 3, 4)
CFG.FITNET.INPUT_SIZE = (256,256)
CFG.FITNET.LOSS = CN()
CFG.FITNET.LOSS.CE_WEIGHT = 0.8
CFG.FITNET.LOSS.FEAT_WEIGHT = 0.2

# KDSVD CFG
CFG.KDSVD = CN()
CFG.KDSVD.K = 1
CFG.KDSVD.LOSS = CN()
CFG.KDSVD.LOSS.CE_WEIGHT = 1.0
CFG.KDSVD.LOSS.FEAT_WEIGHT = 1.0

# OFD CFG
CFG.OFD = CN()
CFG.OFD.LOSS = CN()
CFG.OFD.LOSS.CE_WEIGHT = 1.0
CFG.OFD.LOSS.FEAT_WEIGHT = 0.001
CFG.OFD.CONNECTOR = CN()
CFG.OFD.CONNECTOR.KERNEL_SIZE = 1

# NST CFG
CFG.NST = CN()
CFG.NST.LOSS = CN()
CFG.NST.LOSS.CE_WEIGHT = 0.8
CFG.NST.LOSS.FEAT_WEIGHT = 0.2

# PKT CFG
CFG.PKT = CN()
CFG.PKT.LOSS = CN()
CFG.PKT.LOSS.CE_WEIGHT = 1.0
CFG.PKT.LOSS.FEAT_WEIGHT = 30000.0

# SP CFG
CFG.SP = CN()
CFG.SP.LOSS = CN()
CFG.SP.LOSS.CE_WEIGHT = 1.0
CFG.SP.LOSS.FEAT_WEIGHT = 3000.0

# VID CFG
CFG.VID = CN()
CFG.VID.LOSS = CN()
CFG.VID.LOSS.CE_WEIGHT = 1.0
CFG.VID.LOSS.FEAT_WEIGHT = 1.0
CFG.VID.EPS = 1e-5
CFG.VID.INIT_PRED_VAR = 5.0
CFG.VID.INPUT_SIZE = (32, 32)

# CRD CFG
CFG.CRD = CN()
CFG.CRD.MODE = "exact"  # ("exact", "relax")
CFG.CRD.FEAT = CN()
CFG.CRD.FEAT.DIM = 128
CFG.CRD.FEAT.STUDENT_DIM = 256
CFG.CRD.FEAT.TEACHER_DIM = 256
CFG.CRD.LOSS = CN()
CFG.CRD.LOSS.CE_WEIGHT = 1.0
CFG.CRD.LOSS.FEAT_WEIGHT = 0.8
CFG.CRD.NCE = CN()
CFG.CRD.NCE.K = 16384
CFG.CRD.NCE.MOMENTUM = 0.5
CFG.CRD.NCE.TEMPERATURE = 0.07

# ReviewKD CFG
CFG.REVIEWKD = CN()
CFG.REVIEWKD.CE_WEIGHT = 1 #1
CFG.REVIEWKD.REVIEWKD_WEIGHT = 0.2
CFG.REVIEWKD.WARMUP_EPOCHS = 20
CFG.REVIEWKD.SHAPES = [0,8,16,32]
CFG.REVIEWKD.OUT_SHAPES = [1,8,8,16]
CFG.REVIEWKD.IN_CHANNELS = [192,384,768,768]
CFG.REVIEWKD.OUT_CHANNELS = [384,768,768,768]
CFG.REVIEWKD.MAX_MID_CHANNEL = 768
CFG.REVIEWKD.STU_PREACT = False




# DKD(Decoupled Knowledge Distillation) CFG
CFG.DKD = CN()
CFG.DKD.CE_WEIGHT = 20
CFG.DKD.ALPHA = 1
CFG.DKD.BETA = 8
CFG.DKD.T = 4.0
CFG.DKD.WARMUP = 20


# DOT CFG
CFG.SOLVER.DOT = CN()
CFG.SOLVER.DOT.DELTA = 0.075

#ReviewKD_AT CFG
CFG.REVIEWKD_AT = CN()
CFG.REVIEWKD_AT.CE_WEIGHT = 1.0
CFG.REVIEWKD_AT.REVIEWKD_WEIGHT = 20.0
CFG.REVIEWKD_AT.WARMUP_EPOCHS = 20
CFG.REVIEWKD_AT.SHAPES = [1, 8, 16, 32]
CFG.REVIEWKD_AT.OUT_SHAPES = [1, 8, 16, 32]
CFG.REVIEWKD_AT.IN_CHANNELS = [96,192, 384, 768]
CFG.REVIEWKD_AT.OUT_CHANNELS = [192, 384, 768, 768]
CFG.REVIEWKD_AT.MAX_MID_CHANNEL = 512
CFG.REVIEWKD_AT.STU_PREACT = False
CFG.REVIEWKD_AT.P = 2


#Two
CFG.Two = CN()
CFG.Two.CE_WEIGHT1 = 1 #1
CFG.Two.CE_WEIGHT2 = 20
CFG.Two.REVIEWKD_WEIGHT = 0.2
CFG.Two.WARMUP_EPOCHS = 20
CFG.Two.SHAPES1 = [0,8,16,32]
CFG.Two.OUT_SHAPES1 = [1,8,8,16]
CFG.Two.IN_CHANNELS1 = [192,384,768,768]
CFG.Two.OUT_CHANNELS1 = [384,768,768,768]
CFG.Two.SHAPES2 = [0,8,16,32]
CFG.Two.OUT_SHAPES2 = [1,8,8,16]
CFG.Two.IN_CHANNELS2 = [192,384,768,768]
CFG.Two.OUT_CHANNELS2 = [512,1024,1024,1024]
CFG.Two.MAX_MID_CHANNEL = 768
CFG.Two.STU_PREACT = False
CFG.Two.ALPHA = 1
CFG.Two.BETA = 8
CFG.Two.T = 4
CFG.Two.WARMUP = 20


#Two1
CFG.Two1 = CN()
CFG.Two1.CE_WEIGHT2 = 20
CFG.Two1.ALPHA = 1
CFG.Two1.BETA = 8
CFG.Two1.T = 4.0
CFG.Two1.WARMUP = 20
CFG.Two1.HINT_LAYER = 2  # (0, 1, 2, 3, 4)
CFG.Two1.INPUT_SIZE = (256,256)
CFG.Two1.LOSS = CN()
CFG.Two1.LOSS.CE_WEIGHT1 = 0.8
CFG.Two1.LOSS.FEAT_WEIGHT1 = 0.2

#Two2
CFG.Two2 = CN()
CFG.Two2.CE_WEIGHT1 = 1 #1
CFG.Two2.CE_WEIGHT2 = 0.8
CFG.Two2.REVIEWKD_WEIGHT = 0.2
CFG.Two2.WARMUP_EPOCHS = 20
CFG.Two2.SHAPES1 = [0,8,16,32]
CFG.Two2.OUT_SHAPES1 = [1,8,8,16]
CFG.Two2.IN_CHANNELS1 = [192,384,768,768]
CFG.Two2.OUT_CHANNELS1 = [384,768,768,768]
CFG.Two2.SHAPES2 = [0,8,16,32]
CFG.Two2.OUT_SHAPES2 = [1,8,8,16]
CFG.Two2.IN_CHANNELS2 = [192,384,768,768]
CFG.Two2.OUT_CHANNELS2 = [512,1024,1024,1024]
CFG.Two2.MAX_MID_CHANNEL = 768
CFG.Two2.STU_PREACT = False
CFG.Two2.TEMPERATURE = 4
CFG.Two2.LOSS = CN()
CFG.Two2.LOSS.KD_WEIGHT = 0.2