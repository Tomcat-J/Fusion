# 医学图像分类模型优化研究 - 一页纸总结

## 研究概述

本研究针对医学图像分类任务，从**特征融合**、**分类决策**、**知识蒸馏**三个维度进行系统性优化，旨在提升模型在长尾分布、小样本医学数据集上的性能。

---

## 一、特征融合模块增强 (MHF_block Enhancement)

### 1.1 工作量
| 项目 | 内容 |
|------|------|
| 核心代码 | `mhf_enhancement.py` (~900行) |
| 新增模块 | `EnhancementModuleLite`, `AMAFDSGModule`, `MHF_block_v2` |
| 配套工具 | 差异化学习率、冻结/解冻控制、验证工具 |
| 文档 | 中文使用手册、设计文档、任务清单 |

### 1.2 创新点
1. **超轻量级增强设计**: 参数量 < 原模块1%，不影响推理速度
2. **零初始化保证**: 增强模块初始输出为零，确保与预训练权重完美兼容
3. **非侵入式架构**: 保持原始MHF_block结构不变，通过继承实现增强
4. **多尺度注意力融合**: 
   - 通道注意力: 局部(1×1卷积) + 全局(GAP+MLP) 双分支自适应融合
   - 空间注意力: 3×3 + 5×5 多尺度感受野跨尺度融合
5. **动态缩放门控**: 可学习的全局+通道级缩放因子

### 1.3 理论提升
- **迁移学习友好**: 零初始化确保预训练知识不被破坏
- **特征表达增强**: 多尺度注意力捕获局部细节和全局语义
- **训练稳定性**: 差异化学习率策略保护预训练特征

---

## 二、多原型分类头 (Multi-Prototype Classification Head)

### 2.1 工作量
| 项目 | 内容 |
|------|------|
| 核心代码 | `head.py` (~300行) |
| 核心组件 | `MixedAttentionBlock`, `DynamicPrototypeManager`, `BalancedPrototypeLoss` |
| 创新机制 | 动态原型扩展、混合注意力、长尾平衡损失、动量推送 |

### 2.2 创新点
1. **动态原型管理**:
   - 每类支持5-10个可学习原型
   - 基于方差阈值的动态原型扩展
   - 动量更新机制保证原型稳定性

2. **混合注意力机制**:
   - Cross-Attention: 原型与图像特征交互
   - Self-Attention: 原型内部关系建模
   - Local Self-Attention: 局部细粒度特征捕获
   - 门控融合: 自适应平衡三种注意力贡献

3. **长尾平衡损失**:
   - Cluster Loss: 类内紧凑性，带类别权重平衡
   - Separation Loss: 类间分离性，带margin约束
   - Diversity Loss: 原型多样性，防止原型坍塌
   - Contrastive Loss: 全局原型对比学习

4. **可学习损失权重**: 使用不确定性加权自动平衡CE和原型损失

### 2.3 理论提升
- **可解释性**: 原型提供直观的分类依据
- **长尾鲁棒性**: 平衡损失缓解类别不平衡问题
- **细粒度识别**: 多原型捕获类内多模态分布

---

## 三、知识蒸馏策略探索

### 3.1 蒸馏方法分类

| 类型 | 方法 | 核心思想 | 损失函数 |
|------|------|----------|----------|
| **响应蒸馏** | KD | 软标签知识传递 | KL散度(logits) |
| **特征蒸馏** | FitNet | 中间层特征对齐 | MSE(features) |
| **关系蒸馏** | RKD | 样本间关系保持 | 距离+角度损失 |
| **对比蒸馏** | CRD | 对比表示学习 | InfoNCE |

### 3.2 两两组合验证方案

| 组合 | 损失函数 | 预期优势 | 适用场景 |
|------|----------|----------|----------|
| **响应+特征** | L_KD + L_FitNet | 同时传递决策知识和特征表示 | 通用场景 |
| **响应+关系** | L_KD + L_RKD | 保持软标签和样本结构 | 细粒度分类 |
| **特征+关系** | L_FitNet + L_RKD | 深层特征对齐+关系保持 | 跨域迁移 |

### 3.3 工作量
| 项目 | 内容 |
|------|------|
| 已有实现 | KD, FitNet, RKD, CRD, AT, DKD, ReviewKD等 |
| 配置文件 | `configs/cifar100/*.yaml` |
| 待实现 | 组合蒸馏器、消融实验脚本 |

### 3.4 创新点
1. **组合蒸馏框架**: 灵活组合不同蒸馏策略
2. **自适应权重**: 可学习的损失权重平衡
3. **医学图像适配**: 针对长尾分布的CB Loss集成

### 3.5 理论提升
- **知识互补**: 不同蒸馏方式传递互补信息
- **泛化增强**: 关系蒸馏提升跨域泛化能力
- **效率提升**: 小模型获得大模型性能

---

## 四、整体创新总结

```
┌─────────────────────────────────────────────────────────────┐
│                    医学图像分类优化框架                        │
├─────────────────────────────────────────────────────────────┤
│  输入图像                                                    │
│     ↓                                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Backbone (ConvNeXt + Swin Transformer)              │   │
│  │ • 差异化学习率保护预训练特征                           │   │
│  └─────────────────────────────────────────────────────┘   │
│     ↓                                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ MHF_block_v2 (增强版特征融合)                        │   │
│  │ • 多尺度通道注意力 (局部+全局)                        │   │
│  │ • 跨尺度空间注意力 (3×3+5×5)                         │   │
│  │ • 零初始化动态缩放门控                               │   │
│  └─────────────────────────────────────────────────────┘   │
│     ↓                                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Multi-Prototype Head (多原型分类头)                  │   │
│  │ • 动态原型管理 (5-10个/类)                           │   │
│  │ • 混合注意力 (Cross+Self+Local)                      │   │
│  │ • 长尾平衡损失                                       │   │
│  └─────────────────────────────────────────────────────┘   │
│     ↓                                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Knowledge Distillation (知识蒸馏)                    │   │
│  │ • 响应蒸馏: 软标签知识                               │   │
│  │ • 特征蒸馏: 中间层对齐                               │   │
│  │ • 关系蒸馏: 样本结构保持                             │   │
│  └─────────────────────────────────────────────────────┘   │
│     ↓                                                       │
│  分类输出                                                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 五、预期实验设计

### 5.1 消融实验
1. MHF增强模块有效性验证
2. 多原型数量敏感性分析
3. 蒸馏组合策略对比

### 5.2 对比实验
1. 与baseline模型对比
2. 与SOTA医学图像分类方法对比
3. 不同数据集泛化性验证

### 5.3 评估指标
- Accuracy, F1-Score, AUC-ROC
- 各类别召回率 (关注长尾类)
- 参数量、FLOPs、推理速度

---

## 六、文件索引

| 模块 | 文件路径 |
|------|----------|
| 特征融合增强 | `projects/mae_lite/mhf_enhancement.py` |
| 多原型分类头 | `projects/mae_lite/head.py` |
| 增强版模型 | `projects/mae_lite/models_mae.py` |
| 蒸馏实现 | `mdistiller/distillers/*.py` |
| 蒸馏配置 | `configs/cifar100/*.yaml` |
| 训练脚本 | `projects/eval_tools/finetuning_mae_exp.py` |
| 使用手册 | `projects/mae_lite/MHF_ENHANCEMENT_使用手册.md` |

---

*文档生成时间: 2026-01-21*
